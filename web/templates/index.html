<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Hooks Debug - Log Viewer</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --success: #4ecca3;
            --warning: #ffc107;
            --info: #00b8d4;
            --border: #2a2a4a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .filters {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="text"], input[type="number"] {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95rem;
            min-width: 150px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }

        input[type="text"] {
            min-width: 250px;
        }

        input[type="number"] {
            width: 80px;
            min-width: auto;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .logs-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .log-entry {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: border-color 0.2s;
        }

        .log-entry:hover {
            border-color: var(--accent);
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
        }

        .log-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .event-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-PreToolUse { background: var(--info); color: #000; }
        .event-PostToolUse { background: var(--success); color: #000; }
        .event-Stop { background: var(--accent); color: #fff; }
        .event-Notification { background: var(--warning); color: #000; }
        .event-UserPromptSubmit { background: #9c27b0; color: #fff; }

        .log-timestamp {
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85rem;
        }

        .log-tool {
            color: var(--text-primary);
            font-weight: 500;
        }

        .log-context {
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 500px;
        }

        .log-context code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.8rem;
        }

        .log-project {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: auto;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .expand-icon {
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .log-entry.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .log-body {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid var(--border);
        }

        .log-entry.expanded .log-body {
            display: block;
        }

        .json-viewer {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .json-key { color: #82aaff; }
        .json-string { color: #c3e88d; }
        .json-number { color: #f78c6c; }
        .json-boolean { color: #c792ea; }
        .json-null { color: #89ddff; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            transition: background 0.3s;
        }

        .live-dot.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .live-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .log-entry.new-entry {
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            0% {
                background: var(--accent);
                transform: scale(1.01);
            }
            100% {
                background: var(--bg-secondary);
                transform: scale(1);
            }
        }

        .new-count {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 8px;
            animation: pulse 1s infinite;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 6px 6px 0 0;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .log-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .summary-item {
            background: var(--bg-tertiary);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .summary-item strong {
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            select, input {
                width: 100%;
            }

            .log-header {
                flex-wrap: wrap;
            }

            .log-project {
                width: 100%;
                margin-left: 0;
                order: 10;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container" style="display: flex; align-items: center;">
            <h1>Claude Hooks Debug</h1>
            <div class="live-indicator">
                <span class="live-dot" id="liveDot"></span>
                <span class="live-text" id="liveText">Connecting...</span>
            </div>
        </div>
    </header>

    <main class="container">
        <form class="filters" method="GET" action="/">
            <div class="filter-group">
                <label>Date</label>
                <select name="date" onchange="this.form.submit()">
                    {% for date in dates %}
                    <option value="{{ date }}" {% if date == current_date %}selected{% endif %}>{{ date }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label>Hook Event</label>
                <select name="hook_event" onchange="this.form.submit()">
                    <option value="">All Events</option>
                    {% for event in hook_events %}
                    <option value="{{ event }}" {% if event == current_hook_event %}selected{% endif %}>{{ event }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label>Tool Name</label>
                <select name="tool_name" onchange="this.form.submit()">
                    <option value="">All Tools</option>
                    {% for tool in tool_names %}
                    <option value="{{ tool }}" {% if tool == current_tool_name %}selected{% endif %}>{{ tool }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label>Search</label>
                <input type="text" name="search" value="{{ search }}" placeholder="Search in logs...">
            </div>

            <div class="filter-group">
                <label>Limit</label>
                <input type="number" name="limit" value="{{ limit }}" min="10" max="1000">
            </div>

            <button type="submit">Apply</button>
            <a href="/" class="btn-secondary" style="padding: 10px 20px; border-radius: 6px; text-decoration: none; background: var(--bg-tertiary); color: var(--text-primary);">Reset</a>
        </form>

        <div class="stats">
            <div class="stat">
                <span>Showing:</span>
                <span class="stat-value">{{ total_count }}</span>
                <span>entries</span>
            </div>
            {% if current_date %}
            <div class="stat">
                <span>Date:</span>
                <span class="stat-value">{{ current_date }}</span>
            </div>
            {% endif %}
        </div>

        <div class="logs-container">
            {% if logs %}
                {% for log in logs %}
                <div class="log-entry" onclick="toggleLog(this)">
                    <div class="log-header">
                        <span class="expand-icon">&#9654;</span>
                        <span class="event-badge event-{{ log.hook_event }}">{{ log.hook_event }}</span>
                        <span class="log-timestamp">{{ log.timestamp }}</span>
                        {% if log.input.tool_name %}
                        <span class="log-tool">{{ log.input.tool_name }}</span>
                        {% endif %}
                        <span class="log-context">
                        {%- if log.hook_event in ['PreToolUse', 'PostToolUse'] and log.input.tool_input -%}
                            {%- if log.input.tool_input.description -%}
                                {{ log.input.tool_input.description }}
                            {%- elif log.input.tool_name == 'Bash' and log.input.tool_input.command -%}
                                <code>{{ log.input.tool_input.command[:80] }}{% if log.input.tool_input.command|length > 80 %}...{% endif %}</code>
                            {%- elif log.input.tool_name in ['Read', 'Write', 'Edit'] and log.input.tool_input.file_path -%}
                                {{ log.input.tool_input.file_path }}
                            {%- elif log.input.tool_name == 'Glob' and log.input.tool_input.pattern -%}
                                {{ log.input.tool_input.pattern }}{% if log.input.tool_input.path %} in {{ log.input.tool_input.path }}{% endif %}
                            {%- elif log.input.tool_name == 'Grep' and log.input.tool_input.pattern -%}
                                {{ log.input.tool_input.pattern }}
                            {%- elif log.input.tool_name == 'WebSearch' and log.input.tool_input.query -%}
                                {{ log.input.tool_input.query[:60] }}{% if log.input.tool_input.query|length > 60 %}...{% endif %}
                            {%- elif log.input.tool_name == 'WebFetch' and log.input.tool_input.url -%}
                                {{ log.input.tool_input.url[:60] }}{% if log.input.tool_input.url|length > 60 %}...{% endif %}
                            {%- elif log.input.tool_name == 'Task' -%}
                                [{{ log.input.tool_input.subagent_type }}] {{ log.input.tool_input.description }}
                            {%- endif -%}
                        {%- elif log.hook_event == 'Notification' -%}
                            {{ log.input.message }}
                        {%- elif log.hook_event == 'UserPromptSubmit' and log.input.prompt -%}
                            {{ log.input.prompt[:80] }}{% if log.input.prompt|length > 80 %}...{% endif %}
                        {%- elif log.hook_event == 'Stop' -%}
                            Session ended
                        {%- endif -%}
                        </span>
                        <span class="log-project" title="{{ log.project_dir }}">{{ log.project_dir }}</span>
                    </div>
                    <div class="log-body">
                        <div class="tabs">
                            <button type="button" class="tab active" onclick="event.stopPropagation(); showTab(this, 'input')">Input</button>
                            <button type="button" class="tab" onclick="event.stopPropagation(); showTab(this, 'full')">Full JSON</button>
                        </div>
                        <div class="tab-content" data-tab="input">
                            <pre class="json-viewer">{{ log.input | tojson(indent=2) }}</pre>
                        </div>
                        <div class="tab-content" data-tab="full" style="display: none;">
                            <pre class="json-viewer">{{ log | tojson(indent=2) }}</pre>
                        </div>
                        {% if log.input.tool_input %}
                        <div class="log-summary">
                            {% if log.input.tool_input.command %}
                            <div class="summary-item"><strong>Command:</strong> {{ log.input.tool_input.command[:100] }}{% if log.input.tool_input.command|length > 100 %}...{% endif %}</div>
                            {% endif %}
                            {% if log.input.tool_input.file_path %}
                            <div class="summary-item"><strong>File:</strong> {{ log.input.tool_input.file_path }}</div>
                            {% endif %}
                            {% if log.input.tool_input.pattern %}
                            <div class="summary-item"><strong>Pattern:</strong> {{ log.input.tool_input.pattern }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <h2>No logs found</h2>
                    <p>Try adjusting your filters or check if hooks are installed.</p>
                </div>
            {% endif %}
        </div>
    </main>

    <script>
        function toggleLog(element) {
            element.classList.toggle('expanded');
        }

        function showTab(button, tabName) {
            const logBody = button.closest('.log-body');
            const tabs = logBody.querySelectorAll('.tab');
            const contents = logBody.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            button.classList.add('active');

            contents.forEach(c => {
                c.style.display = c.dataset.tab === tabName ? 'block' : 'none';
            });
        }

        function highlightJson(text) {
            return text
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: null/g, ': <span class="json-null">null</span>');
        }

        function formatLocalTime(utcTimestamp) {
            // Parse UTC timestamp and convert to local time
            const date = new Date(utcTimestamp);
            if (isNaN(date.getTime())) return utcTimestamp;

            // Format as YYYY-MM-DD HH:MM:SS
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Convert all timestamps to local time
        document.querySelectorAll('.log-timestamp').forEach(el => {
            const utc = el.textContent.trim();
            el.dataset.utc = utc;  // Store original for filtering
            el.textContent = formatLocalTime(utc);
        });

        // Syntax highlight existing JSON viewers
        document.querySelectorAll('.json-viewer').forEach(viewer => {
            try {
                viewer.innerHTML = highlightJson(viewer.textContent);
            } catch (e) {}
        });

        // Get current filters
        const currentDate = '{{ current_date }}';
        const currentHookEvent = '{{ current_hook_event }}';
        const currentToolName = '{{ current_tool_name }}';
        const currentSearch = '{{ search }}';

        // Track seen timestamps to avoid duplicates
        const seenTimestamps = new Set();
        document.querySelectorAll('.log-timestamp').forEach(el => {
            seenTimestamps.add(el.textContent);
        });

        let newCount = 0;

        function getLogContext(log) {
            const hookEvent = log.hook_event;
            const input = log.input || {};
            const toolInput = input.tool_input || {};
            const toolName = input.tool_name || '';

            if (hookEvent === 'PreToolUse' || hookEvent === 'PostToolUse') {
                if (toolInput.description) {
                    return escapeHtml(toolInput.description);
                } else if (toolName === 'Bash' && toolInput.command) {
                    const cmd = toolInput.command.slice(0, 80) + (toolInput.command.length > 80 ? '...' : '');
                    return `<code>${escapeHtml(cmd)}</code>`;
                } else if (['Read', 'Write', 'Edit'].includes(toolName) && toolInput.file_path) {
                    return escapeHtml(toolInput.file_path);
                } else if (toolName === 'Glob' && toolInput.pattern) {
                    let ctx = escapeHtml(toolInput.pattern);
                    if (toolInput.path) ctx += ' in ' + escapeHtml(toolInput.path);
                    return ctx;
                } else if (toolName === 'Grep' && toolInput.pattern) {
                    return escapeHtml(toolInput.pattern);
                } else if (toolName === 'WebSearch' && toolInput.query) {
                    const q = toolInput.query.slice(0, 60) + (toolInput.query.length > 60 ? '...' : '');
                    return escapeHtml(q);
                } else if (toolName === 'WebFetch' && toolInput.url) {
                    const u = toolInput.url.slice(0, 60) + (toolInput.url.length > 60 ? '...' : '');
                    return escapeHtml(u);
                } else if (toolName === 'Task') {
                    return `[${escapeHtml(toolInput.subagent_type || '')}] ${escapeHtml(toolInput.description || '')}`;
                }
            } else if (hookEvent === 'Notification') {
                return escapeHtml(input.message || '');
            } else if (hookEvent === 'UserPromptSubmit' && input.prompt) {
                const p = input.prompt.slice(0, 80) + (input.prompt.length > 80 ? '...' : '');
                return escapeHtml(p);
            } else if (hookEvent === 'Stop') {
                return 'Session ended';
            }
            return '';
        }

        function createLogEntry(log) {
            const toolInput = log.input?.tool_input || {};
            const command = toolInput.command || '';
            const filePath = toolInput.file_path || '';
            const pattern = toolInput.pattern || '';

            let summaryHtml = '';
            if (command || filePath || pattern) {
                summaryHtml = '<div class="log-summary">';
                if (command) {
                    const truncated = command.length > 100 ? command.slice(0, 100) + '...' : command;
                    summaryHtml += `<div class="summary-item"><strong>Command:</strong> ${escapeHtml(truncated)}</div>`;
                }
                if (filePath) {
                    summaryHtml += `<div class="summary-item"><strong>File:</strong> ${escapeHtml(filePath)}</div>`;
                }
                if (pattern) {
                    summaryHtml += `<div class="summary-item"><strong>Pattern:</strong> ${escapeHtml(pattern)}</div>`;
                }
                summaryHtml += '</div>';
            }

            const div = document.createElement('div');
            div.className = 'log-entry new-entry';
            div.onclick = function() { toggleLog(this); };
            const context = getLogContext(log);

            div.innerHTML = `
                <div class="log-header">
                    <span class="expand-icon">&#9654;</span>
                    <span class="event-badge event-${log.hook_event}">${log.hook_event}</span>
                    <span class="log-timestamp" data-utc="${log.timestamp}">${formatLocalTime(log.timestamp)}</span>
                    ${log.input?.tool_name ? `<span class="log-tool">${log.input.tool_name}</span>` : ''}
                    <span class="log-context">${context}</span>
                    <span class="log-project" title="${escapeHtml(log.project_dir || '')}">${escapeHtml(log.project_dir || '')}</span>
                </div>
                <div class="log-body">
                    <div class="tabs">
                        <button type="button" class="tab active" onclick="event.stopPropagation(); showTab(this, 'input')">Input</button>
                        <button type="button" class="tab" onclick="event.stopPropagation(); showTab(this, 'full')">Full JSON</button>
                    </div>
                    <div class="tab-content" data-tab="input">
                        <pre class="json-viewer">${highlightJson(JSON.stringify(log.input, null, 2))}</pre>
                    </div>
                    <div class="tab-content" data-tab="full" style="display: none;">
                        <pre class="json-viewer">${highlightJson(JSON.stringify(log, null, 2))}</pre>
                    </div>
                    ${summaryHtml}
                </div>
            `;
            return div;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function matchesFilters(log) {
            if (currentHookEvent && log.hook_event !== currentHookEvent) return false;
            if (currentToolName && log.input?.tool_name !== currentToolName) return false;
            if (currentSearch) {
                const logStr = JSON.stringify(log).toLowerCase();
                if (!logStr.includes(currentSearch.toLowerCase())) return false;
            }
            return true;
        }

        function updateCounter() {
            const statsValue = document.querySelector('.stat-value');
            if (statsValue && newCount > 0) {
                let badge = document.querySelector('.new-count');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'new-count';
                    statsValue.parentNode.appendChild(badge);
                }
                badge.textContent = `+${newCount} new`;
            }
        }

        // SSE Connection
        function connectSSE() {
            const liveDot = document.getElementById('liveDot');
            const liveText = document.getElementById('liveText');
            const logsContainer = document.querySelector('.logs-container');

            const url = `/api/stream${currentDate ? '?date=' + currentDate : ''}`;
            const eventSource = new EventSource(url);

            eventSource.onopen = function() {
                liveDot.classList.add('connected');
                liveText.textContent = 'Live';
            };

            eventSource.onmessage = function(event) {
                try {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'connected') {
                        liveDot.classList.add('connected');
                        liveText.textContent = 'Live';
                    } else if (msg.type === 'log') {
                        const log = msg.data;

                        // Skip if already seen
                        if (seenTimestamps.has(log.timestamp)) return;
                        seenTimestamps.add(log.timestamp);

                        // Check filters
                        if (!matchesFilters(log)) return;

                        // Remove empty state if present
                        const emptyState = logsContainer.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();

                        // Add new entry at top
                        const entry = createLogEntry(log);
                        logsContainer.insertBefore(entry, logsContainer.firstChild);

                        // Remove highlight after animation
                        setTimeout(() => entry.classList.remove('new-entry'), 2000);

                        newCount++;
                        updateCounter();
                    } else if (msg.type === 'newday') {
                        liveText.textContent = 'New day - refresh for new logs';
                    }
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            };

            eventSource.onerror = function() {
                liveDot.classList.remove('connected');
                liveText.textContent = 'Disconnected - retrying...';

                // EventSource auto-reconnects, but update UI
                setTimeout(() => {
                    if (eventSource.readyState === EventSource.CONNECTING) {
                        liveText.textContent = 'Reconnecting...';
                    }
                }, 1000);
            };

            return eventSource;
        }

        // Start SSE connection
        connectSSE();
    </script>
</body>
</html>
